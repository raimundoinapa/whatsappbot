const generateID=(len=12)=>{let id="",chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(i=0;i<len;i++)id+=chars.charAt(Math.floor(52*Math.random()));return id},getTimestamp=(date=!1)=>{const d=date?new Date(date):new Date;return new Date(d-60*d.getTimezoneOffset()*1e3).toJSON().replace("T"," ").split(".")[0]},path=require("path"),express=require("express"),session=require("express-session"),{body:body,validationResult:validationResult}=require("express-validator"),SSE=require("express-sse"),{Client:Client,LocalAuth:LocalAuth}=require("whatsapp-web.js"),qrcode=require("qrcode-terminal"),port=3001,app=express(),publicFolder=path.join(__dirname,"public"),sseObject={};app.use(session({secret:getTimestamp(),resave:!1,saveUninitialized:!0})),app.use(express.urlencoded({extended:!0})),app.use(express.json()),app.use(express.static(publicFolder)),app.set("view engine","html"),app.engine("html",require("ejs").renderFile),app.set("views",publicFolder);const isNumber=n=>"number"==typeof n&&!isNaN(n),isAuthenticated=(req,res,next)=>{const{clientToken:clientToken}=req.body,resonse={status:"error",message:"Su token es invÃ¡lido o ha vencido.",redirect:"/"};return req?.session&&req?.session?.user&&req?.session?.user?.token?!clientToken||clientToken&&clientToken!=req?.session?.user?.token?res.status(401).json(resonse):next():clientToken?res.status(401).json(resonse):res.redirect("/")};app.get("/",((req,res)=>{res.render("home.html",{})})),app.get("/events",((req,res)=>{sseObject.sse=new SSE({time:getTimestamp()}),res.flush=()=>{},sseObject.sse.init(req,res)}));const startEventsEmitter=(req,res)=>{};app.post("/getinstance",(async(req,res)=>{let instanceResolved=!1;await new Promise((resolve=>{const client=new Client;client.on("qr",(qr=>{console.log("Qr received",qr,sse),client.info.qr=qr,sseObject.sse.send({event:"qr",clientInfo:client.info}),instanceResolved||(instanceResolved=!0,resolve(!0))})),client.on("ready",(r=>{console.log("Client is ready!",r,client),req.session?.clients&&Object.keys(req.session.clients).length||(req.session.clients=[]),req.session.clients.push(client),sseObject.sse.send({clientInfo:client.info})})),client.on("message",(async msg=>{console.log({message:msg}),sseObject.sse.send({message:msg}),"klk"==msg.body&&await msg.reply("manso"),"ok"===msg.body&&(console.log(msg.from),await client.sendMessage(msg.from,"cool"))})),client.on("change_state",(state=>{console.log("CHANGE STATE",state),sseObject.sse.send({state:state})})),client.on("disconnected",(reason=>{console.log("Client was logged out",reason),sseObject.sse.send({disconnected:reason})})),client.initialize()}));return res.status(200).json({message:"Instancia de Whatsapp iniciada"})})),app.get("/client/:user",[body("text").trim().notEmpty()],((req,res)=>{let client=!1;if(!req?.session?.clients?.length)for(const c of req.session.clients)if(req.params.user==c.info.me.user){client=c.info.me.user;break}if(!client)return res.status(404).json({message:"Cliente no encontrado"})})),app.listen(3001,(()=>{console.log("Server is running at http://localhost:3001")}));